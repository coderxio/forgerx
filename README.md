# Medication Diversification Tool

The Medication Diversification Tool (MDT) leverages publicly-available, government-maintained datasets to enhance [Synthea’s Synthetic Patient Generator](https://github.com/synthetichealth/synthea). The synthetic health data generated by Synthea can be used by researchers, software developers, policymakers, and clinicians to develop healthcare solutions. In its current state, the process for generating medications in Synthea is manual and limited to a small selection of medications in individual modules. The goal for the MDT is to create more diverse synthetic patient medication orders that accurately reflects the heterogeneity of medications being prescribed in the US population.

The MDT automates the process for finding relevant medication codes and calculating a distribution of medications, using medication classification dictionaries from RxClass and population-level prescription data from the Medical Expenditure Panel Survey (MEPS). The medication distributions can be tailored to specific patient demographics (e.g., age, gender, state of residence) and combined with Synthea data to generate medication records for a sample patient population.


## Contribution guide
1. Setup a venv with `python -m venv venv` (or on windows `py -m venv venv`), this will create a a directory called venv in your current working directory
2. Activate your venv with `source venv/bin/activate` (or on windows `venv/scripts/activate`)
- If using [VSCode](https://code.visualstudio.com/docs/python/python-tutorial#_install-and-use-packages) on Windows and getting error "Activate.ps1 is not digitally signed. You cannot run this script on the current system.", then you may need to temporarily change the PowerShell execution policy to allow scripts to run.  If this is the case, try `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process` and then repeat step 2. 
3. Install MDT with `pip install -e .` (note the `.` after `-e`), this sets up mdt as an installed editable package
4. Change to a new directory outside of the `medication-diversification/` project folder to test out MDT.
- `cd ..`
- `mkdir mdt-test`
- `cd mdt-test`
5. Initialize MDT with `mdt init`. This will create a `data/` directory and load the `MDT.db` database.
6. Create a new module folder with `mdt module -n <<module_name>> create`. This will create a `<<module_name>>/` directory which is empty except for an initial `settings.yaml` file.
7. Edit the `settings.yaml` folder, following the directions in this README.
8. Build the module with `mdt module -n <<module_name>> build`. This will create:
- A `<<module_name>>.json` file which is the Synthea module itself
- A `lookup_tables/` folder with all transition table CSVs
- A `log/` with helpful output logs and debugging CSVs


## User-defined settings

### Module settings
| Setting | Type | Description |
| ------- | ---- | ----------- |
| `name` | `string` | The name of your module.  Defaults to the `camel_case` name of the module folder. Also used as `assign_to_attribute` property by default. |
| `assign_to_attribute` | `string` | **(optional)** The name of the `"attribute"` to assign this state to. Defaults to `<<module_name>>_prescription`. |
| `reason` | `string` | **(optional)** Either an `"attribute"` or a `"State_Name"` referencing a *previous* `ConditionOnset` state. |
| `chronic` | `boolean` | **(optional)** If `true`, a medication is considered a chronic medication for a chronic condition. This will cause Synthea to reissue the same medication as a new prescription AND discontinue the old prescription at each wellness encounter. |
| `as_needed` | `boolean` | **(optional)** If `true`, the medication may be taken as needed instead of on a specific schedule. |
| `refills` | `integer` | **(optional)** The number of refills to allow.  If not specified, defaults to `0`. |

### RxClass settings
| Setting | Type | Description |
| ------- | ---- | ----------- |
| `include` | `list of objects` | `class_id` / `relationship` pairs of RxClass classes to include. |
| `exclude` | `list of objects` | `class_id` / `relationship` pairs of RxClass classes to exclude. |

### RXCUI settings
| Setting | Type | Description |
| ------- | ---- | ----------- |
| `include` | `list of strings` | RXCUIs to include. |
| `exclude` | `list of strings` | RXCUIs to exclude. |
| `ingredient_tty_filter` | `string` | **(optional)** `"IN"` to only return single ingredient products or `"MIN"` to only return multiple ingredient products. |
| `dose_form_filter` | `list of strings` | **(optional)** A list of dose forms or dose form group names to filter products by. See this [RxNorm reference](https://www.nlm.nih.gov/research/umls/rxnorm/docs/appendix3.html) for valid options. |

### MEPS settings
| Setting | Type | Description |
| ------- | ---- | ----------- |
| `age_ranges` | `list of strings` | Age ranges to break up distributions by. |
| `demographic_distribution_flags` | `object` | Whether to break up distributions by `age`, `gender`, and `state`.  All three default to `true`. |


## How to replace a MedicationOrder with a MDT submodule
To replace a MedicationOrder with one of our MDT submodules, replace the [MedicationOrder state](https://github.com/synthetichealth/synthea/wiki/Generic-Module-Framework:-States#medicationorder) with a [CallSubmodule state](https://github.com/synthetichealth/synthea/wiki/Generic-Module-Framework%3A-States#callsubmodule).

```
"Medication_Submodule": {
  "type": "CallSubmodule",
  "submodule": "medications/<<name_of_your_mdt_submodule_here_without_json_file_extension>>"
}
```

Put the submodule JSON file in the [`/src/main/resources/modules/medications`](https://github.com/synthetichealth/synthea/tree/master/src/main/resources/modules/medications) folder.

Put your transition table CSV files in the [`/src/main/resources/modules/lookup_tables`](https://github.com/synthetichealth/synthea/tree/master/src/main/resources/modules/lookup_tables) folder.

**Example for hypothyroidism module:**

Using the existing [hypothyroidism module](https://github.com/synthetichealth/synthea/blob/master/src/main/resources/modules/hypothyroidism.json) as an example...

Change this...

```
    "Synthroid Medication Order": {
      "type": "MedicationOrder",
      "codes": [
        {
          "system": "RxNorm",
          "code": 966222,
          "display": "Levothyroxine Sodium 0.075 MG Oral Tablet"
        }
      ],
      "direct_transition": "end encounter",
      "prescription": {
        "dosage": {
          "amount": 1,
          "frequency": 1,
          "period": 60,
          "unit": "days"
        },
        "duration": {
          "quantity": 60,
          "unit": "days"
        },
        "refills": 6
      }
    },
```

To this...

```
    "Synthroid Medication Order": {
      "type": "CallSubmodule",
      "submodule": "medications/hypothyroidism_medication",
      "direct_transition": "end encounter"
    },
```

And make sure your submodule JSON and transition table CSVs are in the folder locations specified above.
* Put a `hypothyroidism_medication.json` file in the `/src/main/resources/modules/medication` folder
* Put all the transition table CSV files in the `/src/main/resources/modules/lookup_tables` folder

See below for example file structure:

```
src/
├─ main/
│  ├─ resources/
│  │  ├─ modules/
│  │  │  ├─ medication/
│  │  │  │  ├─ hypothyroidism_medication.json
│  │  │  │  ├─ ...
│  │  │  ├─ lookup_tables/
│  │  │  │  ├─ Hypothyroidism_ingredient_distrib.csv
│  │  │  │  ├─ Hypothyroidism_product_levothyroxine_distrib.csv
│  │  │  │  ├─ Hypothyroidism_product_liothyronine_distrib.csv
│  │  │  │  ├─ Hypothyroidism_product_thyroid_USP_distrib.csv
│  │  │  │  ├─ ...
│  │  │  ├─ hypothyroidism.json
│  │  │  ├─ ...
```
