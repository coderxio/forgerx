# Medication Diversification Tool

The Medication Diversification Tool (MDT) leverages publicly-available, government-maintained datasets to enhance [Synthea’s Synthetic Patient Generator](https://github.com/synthetichealth/synthea). The synthetic health data generated by Synthea can be used by researchers, software developers, policymakers, and clinicians to develop healthcare solutions. In its current state, the process for generating medications in Synthea is manual and limited to a small selection of medications in individual modules. The goal for the MDT is to create more diverse synthetic patient medication orders that accurately reflects the heterogeneity of medications being prescribed in the US population.

The MDT automates the process for finding relevant medication codes and calculating a distribution of medications, using medication classification dictionaries from RxClass and population-level prescription data from the Medical Expenditure Panel Survey (MEPS). The medication distributions can be tailored to specific patient demographics (e.g., age, gender, state of residence) and combined with Synthea data to generate medication records for a sample patient population.


## Developer quickstart
1. Clone the repo.
```
git clone https://github.com/coderxio/medication-diversification.git
cd medication-diversification
```
2. Create and activate a venv.
```
python -m venv venv
source venv/bin/activate
```
Or on Windows:
```
py -m venv venv
venv/scripts/activate
```
> If using [VSCode](https://code.visualstudio.com/docs/python/python-tutorial#_install-and-use-packages) on Windows and getting error "Activate.ps1 is not digitally signed. You cannot run this script on the current system.", then you may need to temporarily change the PowerShell execution policy to allow scripts to run.  If this is the case, try `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process` and then repeat step 2. 
3. Install MDT as an editable package (note the `.` after `-e`).
```
pip install -e .
```
4. Change to a new directory outside of the `medication-diversification/` project folder to test out MDT.
```
cd ..
mkdir mdt-test
cd mdt-test
```
5. Initialize MDT to create a `data/` directory and load the `MDT.db` database. This only needs to be done once.
```
mdt init
```
6. Create a new module. This will create a `<<module_name>>/` directory which is empty except for an initial `settings.yaml` file.
```
mdt module -n <<module_name>> create
```
7. Edit the `settings.yaml` folder in the newly created `<<module_name>>/` directory, following the directions in this README.
8. Build the module.
```
mdt module -n <<module_name>> build
```
This will create:
- A `<<module_name>>.json` file which is the Synthea module itself
- A `lookup_tables/` directory with all transition table CSVs
- A `log/` directory with helpful output logs and debugging CSVs
> Repeat steps 7 and 8 until the Synthea module is producing medications that align with what you would expect. Use the `log <<timestamp>>.txt` files in the `log/` directory as a quick and easy way to validate the output of the module with a clinical subject matter expert.
> To create a new module, start at step 6.

## User-defined settings

### Module settings
| Setting | Type | Description |
| ------- | ---- | ----------- |
| `name` | `string` | The name of your module.  Defaults to the `camel_case` name of the module folder. Also used as `assign_to_attribute` property by default. |
| `assign_to_attribute` | `string` | **(optional)** The name of the `"attribute"` to assign this state to. Defaults to `<<module_name>>`. |
| `reason` | `string` | **(optional)** Either an `"attribute"` or a `"State_Name"` referencing a *previous* `ConditionOnset` state. |
| `chronic` | `boolean` | **(optional)** If `true`, a medication is considered a chronic medication for a chronic condition. This will cause Synthea to reissue the same medication as a new prescription AND discontinue the old prescription at each wellness encounter. Defaults to `false`. |
| `as_needed` | `boolean` | **(optional)** If `true`, the medication may be taken as needed instead of on a specific schedule. Defaults to `false`. |
| `refills` | `integer` | **(optional)** The number of refills to allow.  Defaults to `0`. |

### RxClass settings

**NOTE:** At least one RxClass `include` or RXCUI `include` is required to run MDT.

| Setting | Type | Description |
| ------- | ---- | ----------- |
| `include` | `list of objects` | `class_id` / `relationship` pairs of RxClass classes to include. See [RxClass](https://mor.nlm.nih.gov/RxClass/) for valid options. |
| `exclude` | `list of objects` | `class_id` / `relationship` pairs of RxClass classes to exclude. See [RxClass](https://mor.nlm.nih.gov/RxClass/) for valid options. |

Examples:
*Corticosteroid medications*
```
rxclass:
  include:
        - class_id: R01AD
          relationship: ATC
```

*Medications that may treat hypothyroidism*
```
rxclass:
  include:
        - class_id: D007037
          relationship: may_treat
```

*HMG CoA reductase inhibitor medications AND medications that may prevent stroke*
```
rxclass:
  include:
        - class_id: R01AD
          relationship: ATC
        - class_id: D020521
          relationship: may_prevent
```

*Medications that may prevent stroke EXCLUDING P2Y12 platelet inhibitors*
```
rxclass:
  include:
        - class_id: D020521
          relationship: may_prevent
    exclude:
        - class_id: N0000182142
          relationship: has_EPC
```

### RXCUI settings

**NOTE:** At least one RxClass `include` or RXCUI `include` is required to run MDT.

| Setting | Type | Description |
| ------- | ---- | ----------- |
| `include` | `list of strings` | RXCUIs to include. See ingredients section of [RxNav](https://mor.nlm.nih.gov/RxNav/) for valid options. |
| `exclude` | `list of strings` | RXCUIs to exclude. See ingredients section of [RxNav](https://mor.nlm.nih.gov/RxNav/) for valid options. |
| `ingredient_tty_filter` | `string` | **(optional)** `"IN"` to only return single ingredient products or `"MIN"` to only return multiple ingredient products. |
| `dose_form_filter` | `list of strings` | **(optional)** A list of dose forms or dose form group names to filter products by. See this [RxNorm reference](https://www.nlm.nih.gov/research/umls/rxnorm/docs/appendix3.html) for valid options. |

Examples:
*Prednisone medications*
```
rxcui:
    include:
        - '8640'
```

*Albuterol AND levalbuterol medications*
```
rxcui:
    include:
        - '435'
        - '237159'
```

*Fluticasone / salmeterol (TTY = MIN, multiple ingredient) medications*
```
rxcui:
    include:
        - '284635'
```

### MEPS settings
| Setting | Type | Description |
| ------- | ---- | ----------- |
| `age_ranges` | `list of strings` | Age ranges to break up distributions by. Defaults to MDT system defaults. |
| `demographic_distribution_flags` | `object` | Whether to break up distributions by `age`, `gender`, and `state`.  All three default to `true`. |

Examples:
*Custom age ranges for pediatric patients only*
```
meps:
    age_ranges:
        - 0-5
        - 6-12
        - 13-17
```

*Split population under and over 65 years old*
```
meps:
    age_ranges:
        - 0-64
        - 65-103
```

## How to replace a MedicationOrder with a MDT submodule
To replace a MedicationOrder with one of our MDT submodules, replace the [MedicationOrder state](https://github.com/synthetichealth/synthea/wiki/Generic-Module-Framework:-States#medicationorder) with a [CallSubmodule state](https://github.com/synthetichealth/synthea/wiki/Generic-Module-Framework%3A-States#callsubmodule).

```
"Medication_Submodule": {
  "type": "CallSubmodule",
  "submodule": "medications/<<name_of_your_mdt_submodule_here_without_json_file_extension>>"
}
```

Put the submodule JSON file in the [`/src/main/resources/modules/medications`](https://github.com/synthetichealth/synthea/tree/master/src/main/resources/modules/medications) folder.

Put your transition table CSV files in the [`/src/main/resources/modules/lookup_tables`](https://github.com/synthetichealth/synthea/tree/master/src/main/resources/modules/lookup_tables) folder.

**Example for hypothyroidism module:**

Using the existing [hypothyroidism module](https://github.com/synthetichealth/synthea/blob/master/src/main/resources/modules/hypothyroidism.json) as an example...

Change this...

```
    "Synthroid Medication Order": {
      "type": "MedicationOrder",
      "codes": [
        {
          "system": "RxNorm",
          "code": 966222,
          "display": "Levothyroxine Sodium 0.075 MG Oral Tablet"
        }
      ],
      "direct_transition": "end encounter",
      "prescription": {
        "dosage": {
          "amount": 1,
          "frequency": 1,
          "period": 60,
          "unit": "days"
        },
        "duration": {
          "quantity": 60,
          "unit": "days"
        },
        "refills": 6
      }
    },
```

To this...

```
    "Synthroid Medication Order": {
      "type": "CallSubmodule",
      "submodule": "medications/hypothyroidism_medication",
      "direct_transition": "end encounter"
    },
```

And make sure your submodule JSON and transition table CSVs are in the folder locations specified above.
* Put a `hypothyroidism_medication.json` file in the `/src/main/resources/modules/medication` folder
* Put all the transition table CSV files in the `/src/main/resources/modules/lookup_tables` folder

See below for example file structure:

```
src/
├─ main/
│  ├─ resources/
│  │  ├─ modules/
│  │  │  ├─ medication/
│  │  │  │  ├─ hypothyroidism_medication.json
│  │  │  │  ├─ ...
│  │  │  ├─ lookup_tables/
│  │  │  │  ├─ Hypothyroidism_ingredient_distrib.csv
│  │  │  │  ├─ Hypothyroidism_product_levothyroxine_distrib.csv
│  │  │  │  ├─ Hypothyroidism_product_liothyronine_distrib.csv
│  │  │  │  ├─ Hypothyroidism_product_thyroid_USP_distrib.csv
│  │  │  │  ├─ ...
│  │  │  ├─ hypothyroidism.json
│  │  │  ├─ ...
```
