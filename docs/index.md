# Documentation

This is documentation for the Medication Diversification Tool (MDT).

## Getting started

If this is your first time using the repo, the first thing you will need to do is create the `MDT.db` database.
1. Run `meps_data_reader.py` to load MEPS data
1. Run `rxnorm_data_reader.py` to load RxNorm data

You should see a `/data` directory get generated with a `MDT.db` file inside.

### Working with MDT.db

You can download `MDT.db` and query it with [DBeaver](https://dbeaver.io/) or connect with it however you normall work with SQLite files.

### Running the main MDT script

Once the database is created and fully populated, you can edit the line below in `rx_api.py` and change `'D001249'` and `'may_prevent'` to any combination of RxClass ID and relationship.

```
rxclass_response = rxapi_get_requestor(rxclass_getclassmember_payload('D001249','may_prevent'))
```

Run `rx_api.py` and you should see a file called `df_output.csv` generated in the `/data` directory.

This script takes the following steps to generate that file:
1. Call the RxClass API (input = combination of RxClass ID and relationship, output = list of RXCUIs which are either IN or MIN [TTY](https://www.nlm.nih.gov/research/umls/rxnorm/docs/appendix5.html))
1. Query the `rxcui_ndc` table for any rows that have any of these IN /MIN ingredient-level RXCUIs in the `medication_ingredient_rxcui` column OR the `medication_product_rxcui` column
    - This query results in duplicate NDCs (i.e. fluticasone IN and salmeterol IN both point to the same Advair NDC) and fail to provide us with MINs in many cases (i.e. if RxClass only returns fluticason IN and salmeterol IN, we won't have the fluitasone / salmeterol MIN in our results)
1. To solve our duplicate NDC and lack of MINs issue, query the `rxcui_ndc` table a second time for any rows that have the SCD / GPCK / SBD / BPCK product-level RXCUIs in the `medication_ingredient_rxcui` column OR the `medication_product_rxcui` column AND we perform a window function on the results of this query which prefers MIN TTYs over IN TTYs
    - This query results in one row per NDC with no duplicate NDCs and MINs when they are available, but INs when they are not (i.e. the Advair NDC from above would have a fluticasone / salmeterol MIN and NOT have duplicate rows with fluticasone IN and salmeterol IN)
1. TODO: combine this data with MEPS data

### Working with RxClass

You can check out this [RxClass tutorial from National Library of Medicine (NLM)](https://www.nlm.nih.gov/research/umls/user_education/quick_tours/RxClass/RxClass_Searching.html).

## Key files

### Entry point
- `rx_api.py` - this is the main script that runs through the MDT workflow

### Data readers
- `rxnorm_data_reader.py` - gets current RxNorm data tables from NLM and stores in local database
- `meps_data_reader.py` - gets MEPS DAT file, converts to data frame, and stores in local database

### SQL files
- `rxcui_ndc.sql` - creates a view from the RxNorm tables which goes from ingredient TTY RXCUIs (IN/MIN) -> product TTY RXCUIs (SCD/GPCK/SBD/BPC) -> NDC and also includes dose form (DF) information for each product
- `meps_rxcui.py` - merges the MEPS prescriptions table and demographics table

### Config/utility files
- `confing_mdt.py` - configuration file
- `mdt_functions.py` - contains a lot of important functions used in other parts of MDT
- `meps_lists.py` - used to convert the DAT file to a dataframe

## Database

MDT.db is a SQLite database that gets generated by the data reader scripts (`rxnorm_data_reader.py` and `meps_data_reader.py`)

### RxNorm tables

The first three tables are just standard tables provided with each public release of RxNorm.  Feel free to review the [RxNorm Current Prescribable Content documentation](https://www.nlm.nih.gov/research/umls/rxnorm/docs/prescribe.html).

- `rxnconso`
- `rxnsat`
- `rxnrel`
- `rxcui_ndc` - this table/view is generated by the SQL in `rxcui_ndc.sql` which is called by `rxnorm_data_reader.py`

### MEPS tables

- `meps_prescription`
- `meps_demographics`
- `meps_region`
- `meps_reference`
